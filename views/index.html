<!DOCTYPE html>
<html lang='en'>
<head>
  <script type='text/javascript' src='http://maps.google.com/maps/api/js?sensor=false'></script>
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js'></script>

  <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,300' rel='stylesheet' type='text/css'>

  <style>
    * {
      padding:0;
      margin:0;

      font-family: 'Open Sans', sans-serif;
      font-weight:300;
    }
    html, body {
      width: 100%; 
      height: 100%;
      color:black;
    }


    #header {
      position:fixed;
      bottom:130px;
      right:160px;
      z-index:99;
    }

    h1 {
      float:left;
      font-size:50px;
      text-align: center;
      font-weight:700;
    }

    h1 span {
      line-height: 70%;
      display:block;
      font-size: 65px;
      font-weight:300;
    }

    #animation-control-button {
      padding:20px;
      display:inline-block;
      background:white;
      margin: 20px 0 0 20px;
    }

    #animation-control-button:hover {
      background:grey;
    }

    #animation-control-button div {
      width: 30px;
      height: 60px;
    }

    #animation-control-button .play { 
      border: solid transparent;
      margin-left: 10px;
      border-width: 30px 0px 30px 50px;
      border-left-color: black;
      height:0; 
      width:0;
    }

    #animation-control-button .pause {
      width: 30px;
      height: 60px;
      border-left: 15px solid black;
      border-right: 15px solid black;
    }

    #heatmapArea {
      height: 100%;
      width: 100%;
    }

    #progress-bar-background {
      position:fixed;
      width:100%;
      height:3px;
      left:0;
      bottom:0;
      background:white;
      z-index:98;
    }

    #progress-bar-container {
      position:fixed;
      overflow:visible;
      width:5%;
      left:0;
      bottom:0;
      z-index:99;
    }

    #progress-bar-pointer {
      float:right;
      position: relative;
      background:yellow;
      margin-right: -45px;
      margin-bottom:20px;
      padding-top:20px;
      text-align:center;
      height:55px;
      width:90px;


      
      cursor: pointer;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #progress-bar-pointer:after {
      position: absolute;
      content: ' ';
      top: 100%;
      left: 50%;
      border: solid transparent;
      border-top-color: yellow;
      border-width: 15px;
      margin-left: -15px;
    }

    #progress-bar-pointer span {
      font-size:10px;
      line-height:150%;
    }

    #progress-bar {
      position:absolute;
      background:#327CCB;
      width:100%;
      right:0;
      bottom:0;
      height:3px;
    }

    
  </style>
  </head>
<body>

<div id='header'>
  <h1>Halifax<span>Crime</span></h1>
  <div id='animation-control-button'>
    <div class='pause'></div>
  </div>
</div>

<div id='heatmapArea'></div>

<div id='progress-bar-background'> </div>
<div id='progress-bar-container'>
  <div id='progress-bar-pointer-container'> 
    <div id='progress-bar-pointer'></div>
  </div>
  <div id='progress-bar'> </div>
</div>

<script type='text/javascript' src='heatmap.js'></script>
<script type='text/javascript' src='heatmap-gmaps.js'></script>
<script type='text/javascript'>

 //http://heatmapdemo.alastair.is/js/map/heatmaplayer.js
  //http://eightmedia.github.io/hammer.js/

 /*
   * emits events after each animation frame and after animation is complete
  */
  var CrimeAnimator = function(data, heatmap, map) { 
    
    this.map = map;
    this.data = data;
    this.heatmap = heatmap;
    this.dataLength = data.length;
    this.markers = [];

    //figure out the date range
    this.dateRange = {start: data[0][3], end: data[data.length-1][3]};
    this.dayRange = Math.ceil((this.dateRange.end - this.dateRange.start) / this.DAY_IN_MILLI);

    this.isPaused = false;

    //set the first day to draw to our earliest crime
    this.currentDate = this.dateRange.start;
    this.lastDrawTime = new Date().getTime();

    //calculate the number of days that elapse for each animation frame
    this.animationTimeMultiplier = 100000; //TODO: speed this up depending on dayRange

    //calculate how long crimes should be displayed for based on our range
    this.visibleLifespan = Math.ceil(this.dayRange / 10);
    if(this.visibleLifespan < 10)
      this.visibleLifespan = 10;
    else if(this.visibleLifespan > 30)
      this.visibleLifespan = 30;
    this.visibleLifespan = this.visibleLifespan * this.DAY_IN_MILLI;

    this.lowIndex = 0; //holds the data index of the oldest crime we are displaying
    this.highIndex = 0; //holds the data index of the newest crime we are displaying

    this.filters = [];

    this.setupProgressBar();

    var self = this;

    var $animationControlButton = $('#animation-control-button');
    $animationControlButton.click(function() {
      if(self.isPaused)
        self.resume();
      else
        self.pause();
    });

    this.$animationControl = $animationControlButton.children('div');
  };

  CrimeAnimator.prototype.DAY_IN_MILLI = 1000 * 60 * 60 * 24;

  CrimeAnimator.prototype.setupProgressBar = function setupProgressBar() {

    //setup progress bar slider events
    this.$progressBar = $('#progress-bar-container');
    var $progressBarPointer = $('#progress-bar-pointer');
    var $document = $(document);
    
    this.progressBarStartPosition = Math.ceil($document.width() * 0.05);
    this.progressBarEndPosition = $document.width() - this.progressBarStartPosition;
    this.$progressBar.css('width', this.progressBarStartPosition + 'px');

    this.totalTimeRange = this.dateRange.end - this.dateRange.start;   
    this.totalPixelRange = this.progressBarEndPosition - this.progressBarStartPosition;

    var self = this;
    var stopPointerDrag = function(e) {
      self.updateCurrentDateToProgressPosition(e.pageX);
      
      //draw the heatmap frame for our current position
      self.lowIndex = 0; 
      self.highIndex = 0;
      self.drawFrame(self.currentDate);

      self.removeCrimeMarkers();
      self.addCrimeMarkers();

      $document.off('mousemove ontouchmove');
    };

    //keep track of the top of the progres bar so that we can stop dragging when the mouse leaves the top 
    var pointerOffsetTop = $progressBarPointer.offset().top;
    $(window).resize(function() {
      pointerOffsetTop = $progressBarPointer.offset().top;
    });

    //setup dragability of progress bar pointer
    $progressBarPointer.on('mousedown ontouchstart', function() {
      self.pause.apply(self);

      $document.on('mousemove ontouchmove', function(e) {
        if(e.pageY < pointerOffsetTop) {
          stopPointerDrag(e);
          return;
        }

        //impose start/end limits on progres bar
        var x = e.pageX;
        if(x > this.progressBarEndPosition)
          x = this.progressBarEndPosition;
        else if(x < self.progressBarStartPosition)
          x = self.progressBarStartPosition;

        self.$progressBar.css('width', x + 'px');

        //update progress bar text
        self.updateCurrentDateToProgressPosition(x);
        self.updateProgressBarText();

        //TODO: performance test this
        //self.drawFrame(self.currentDate);
      });
    });

    //stop dragging 
    $progressBarPointer.on('mouseup ontouchend', stopPointerDrag);

    this.$progressBarPointer = $progressBarPointer;
  };

  var monthNames = [ 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December' ];
  CrimeAnimator.prototype.updateProgressBar = function updateProgressBar() {
      var x = (this.progressBarStartPosition + (((this.currentDate - this.dateRange.start) / this.totalTimeRange) * this.totalPixelRange));
      if(x > this.progressBarEndPosition)
        x = this.progressBarEndPosition;

      this.$progressBar.css('width' , x + 'px');

      this.updateProgressBarText();
  };

  CrimeAnimator.prototype.updateCurrentDateToProgressPosition = function updateCurrentDateToProgressPosition(progressPosition) {
      //calc the current position of pointer and translate that into an animation position date
      var progressBarPercentComplete = (progressPosition - this.progressBarStartPosition) / this.totalPixelRange;
      this.currentDate = this.dateRange.start + ((this.dateRange.end - this.dateRange.start) * progressBarPercentComplete);
  };

  CrimeAnimator.prototype.updateProgressBarText = function updateProgressBarText() {
        var now = new Date(this.currentDate);
        this.$progressBarPointer.html(monthNames[now.getMonth()] + '<br>' + now.getDate() + '<span>' + getNumberPostfix(now.getDate()) + '</span>');
  };

  var numberEndings = ['', 'st', 'nd', 'rd', 'th'];
  function getNumberPostfix(number) {
    return numberEndings[number >= numberEndings.length ? numberEndings.length - 1 : number];
  };

  CrimeAnimator.prototype.applyFilters = function setData(filters) {
    this.filters = filters;
  };

  CrimeAnimator.prototype.updateIndexPositions = function updateIndexPositions(visibleThreshold, nextDate) {
    while(this.lowIndex < this.dataLength) {
      if(this.data[this.lowIndex][3] >= visibleThreshold)
        break;

      this.lowIndex += 1;
    }

    if(this.highIndex < this.lowIndex)
      this.highIndex = this.lowIndex;
  
    while(this.highIndex < this.dataLength) {
      var crime = this.data[this.highIndex];
      if(this.data[this.highIndex][3] >= nextDate)
        break;

      this.highIndex += 1;
    }
  },

  CrimeAnimator.prototype.drawFrame = function drawFrame(nextDate) {
      
      var visibleThreshold = this.currentDate - this.visibleLifespan;
      this.updateIndexPositions(visibleThreshold, nextDate);

      //if no removals to make then just add the crime points that are between the currentDate and the next Date and aren't filtered
      var currentData = this.getCurrentHeatmapData(this.lowIndex, this.highIndex, visibleThreshold);
      this.heatmap.setDataSet(currentData); 

  },

  CrimeAnimator.prototype.animate = function animate() {
    
    var now = new Date().getTime();

    if(!this.isPaused) {
      var nextDate = this.currentDate + ((now - this.lastDrawTime) * this.animationTimeMultiplier);

      this.drawFrame(nextDate);

      //increment currentDate to next date
      this.currentDate = nextDate;

      //update our current progress to match the current date
      this.updateProgressBar();
    }

    this.lastDrawTime = now;

    if (this.highIndex < this.dataLength - 1)
      window.requestAnimationFrame(this.animate.bind(this));
  };

  CrimeAnimator.prototype.start = function start(startDate) {

    if(startDate)
      this.currentDate = startDate;

    //start the animation
    this.animate();
  }

  CrimeAnimator.prototype.pause = function pause() {
    console.log('pausing');

    this.$animationControl.removeClass('pause');
    this.$animationControl.addClass('play');     

    this.addCrimeMarkers();

    this.isPaused = true;
  };


  CrimeAnimator.prototype.addCrimeMarkers = function addCrimeMarkers() {
    var currentData = this.data.slice(this.lowIndex, this.highIndex + 1);
    for(var i=currentData.length-1 ; i >= 0 ; i--) {
      var crime = currentData[i];

      this.markers.push(new google.maps.Marker({
        position: new google.maps.LatLng(crime[0], crime[1]),
        map: this.map,
        title: 'title'
      }));
    }
  };

  CrimeAnimator.prototype.removeCrimeMarkers = function removeCrimeMarkers() {
    for(var i=this.markers.length-1 ; i >= 0 ; i--) {
      this.markers.pop().setMap(null);
    }
  };

  CrimeAnimator.prototype.resume = function resume() {
    console.log('resume');

    this.$animationControl.removeClass('play');
    this.$animationControl.addClass('pause');

    this.removeCrimeMarkers();

    this.isPaused = false;
  };

  CrimeAnimator.prototype.getCurrentHeatmapData = function getCurrentHeatmapData(lowIndex, highIndex, visibleThreshold) {
    var currentData = this.data.slice(this.lowIndex, this.highIndex + 1);
    
    var crime, type, count, timeFromHighIndex, timeRange, heatmapData = [];
    var currentTimeRange = this.currentDate - visibleThreshold;

    for(var i = currentData.length-1 ; i >= 0 ; i--) {
      crime = currentData[i];
      type = crime[2];

      if(this.filters.indexOf(type) >= 0)
        continue;

      timeFromHighIndex = this.currentDate - crime[3];
      var x = timeFromHighIndex / currentTimeRange;
      count = 50 * 4 * (x - Math.pow(x, 2)); //exponential curve for fade in/out
                      
      heatmapData.push({lat : crime[0], lng : crime[1], count: count});
    }

    return {max: 75, data: heatmapData};
  };

  !function($){
    $(function(){

      var myLatlng = new google.maps.LatLng(44.6544, -63.5992);

      var myOptions = {
        zoom: 12,
        center: myLatlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        disableDefaultUI: true,
        scrollwheel: true,
        draggable: true,
        navigationControl: true,
        mapTypeControl: true,
        scaleControl: true,
        disableDoubleClickZoom: true
      };
      var map = new google.maps.Map($('#heatmapArea')[0], myOptions);
      
      var heatmap = new HeatmapOverlay(map, {
          'radius':30,
          'visible':true, 
          'opacity':60
      });

      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || 
                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || 
                              function(fn) {return setTimeout(fn, 1000 / 60);};

      // this is important, because if you set the data set too early, the latlng/pixel projection doesn't work
      google.maps.event.addListenerOnce(map, 'idle', function() {

          var crimeAnimator = new CrimeAnimator(Data.crimes, heatmap, map);
          crimeAnimator.start();

      });
    });
  }(window.jQuery);

  var Data = <%- JSON.stringify(data) %>;
  
  //transform and inflate dates from server and create mock times so that each days data is at least somewhat distributed
  var year = Data.year;
  var crimes = Data.crimes;
  for(var i=crimes.length-1 ; i >= 0 ; i--) {
    var crime = crimes[i];
    crime[3] = Date.parse(year + '/' + (crime[3]+1) + '/' + crime[4] +  ' ' + Math.floor(Math.random()*24) + ':00');
  }

</script>
</body>
</html>



