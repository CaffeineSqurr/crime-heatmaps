<!DOCTYPE html>
<html lang="en">
<head>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  
  <style>
    * {
      padding:0;
      margin:0;

      font-family: Arial, san-serif;
    }
    html, body {
      width: 100%; 
      height: 100%;
      color:black;
    }

    h1 {
      position:fixed;
      margin: 20px 0 0 20px;
      z-index:99;
    }

    #heatmapArea {
      height: 100%;
      width: 100%;
    }

    #progress-bar-background {
      position:fixed;
      width:100%;
      height:3px;
      left:0;
      bottom:0;
      background:white;
      z-index:98;
    }

    #progress-bar-container {
      position:fixed;
      overflow:visible;
      width:30%;
      left:0;
      bottom:0;
      z-index:99;
    }

    #progress-bar-pointer {
      float:right;
      position: relative;
      background:yellow;
      margin-right: -25px;
      margin-bottom:20px;
      padding:10px;
      text-align:center;
      
      cursor: pointer;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #progress-bar-pointer:after {
      position: absolute;
      content: " ";
      top: 100%;
      left: 50%;
      border: solid transparent;
      border-top-color: yellow;
      border-width: 15px;
      margin-left: -15px;
    }

    #progress-bar-pointer span {
      font-size:10px;
      line-height:150%;
    }

    #progress-bar {
      position:absolute;
      background:#327CCB;
      width:100%;
      right:0;
      bottom:0;
      height:3px;
    }
    
  </style>
  </head>
<body>

<h1>Halifax Crime Heatmap</h1>
<div id="heatmapArea"></div>

<div id='progress-bar-background'> </div>
<div id='progress-bar-container'>
  <div id='progress-bar-pointer-container'> 
    <div id='progress-bar-pointer'>Sept<br>29<span>th</span></div>
  </div>
  <div id='progress-bar'> </div>
</div>

<script type="text/javascript" src="heatmap.js"></script>
<script type="text/javascript" src="heatmap-gmaps.js"></script>
<script type="text/javascript">

  //http://heatmapdemo.alastair.is/js/map/heatmaplayer.js

 /*
   * emits events after each animation frame and after animation is complete
  */
  var CrimeAnimator = function(data, heatmap) { 
    
    this.data = data;
    this.heatmap = heatmap;
    this.dataLength = data.length;

    //figure out the date range
    this.dateRange = {start: data[0][3], end: data[data.length-1][3]};
    this.dayRange = Math.ceil((this.dateRange.end - this.dateRange.start) / this.DAY_IN_MILLI);

    this.isPaused = false;

    //set the first day to draw to our earliest crime
    this.currentDate = this.dateRange.start;
    this.lastDrawTime = new Date().getTime();

    //calculate the number of days that elapse for each animation frame
    this.animationTimeMultiplier = 100000; //TODO: speed this up depending on dayRange

    //calculate how long crimes should be displayed for based on our range
    this.visibleLifespan = Math.ceil(this.dayRange / 10);
    if(this.visibleLifespan < 10)
      this.visibleLifespan = 10;
    else if(this.visibleLifespan > 30)
      this.visibleLifespan = 30;
    this.visibleLifespan = this.visibleLifespan * this.DAY_IN_MILLI;

    this.lowIndex = 0; //holds the data index of the oldest crime we are displaying
    this.highIndex = 0; //holds the data index of the newest crime we are displaying

    this.filters = [];

    //this.setupProgressBar();
  };

  CrimeAnimator.prototype.DAY_IN_MILLI = 1000 * 60 * 60 * 24;

  CrimeAnimator.prototype.setupProgressBar = function setupProgressBar() {
      //setup the progress bar for our current date range
    this.progressBar = $('#progress-bar');

    this.totalTimeRange = this.dateRange.end - this.dateRange.start;

    //disable months we don't have data for and determine the pixel distance to use for our progress bar
    var firstMonth = new Date(this.dateRange.start).getMonth();
    var lastMonth = new Date(this.dateRange.end).getMonth();

    //TODO: the start/end should be based off determining the height of one month and then calcing the rest so that we can get good indicators for partial months
    this.progressStart = null;
    this.progressEnd = null;
    var monthElements = this.progressBar.children();
    for(var i=0 ; i < 12 ; i++) {
      var $monthElement = $(monthElements[i]);

      if(i < firstMonth || i > lastMonth) 
        $monthElement.addClass('disabled');

      else if(!this.progressStart) 
        this.progressStart = $monthElement.position().top;

      else if(!this.progressEnd && i === lastMonth)
        this.progressEnd = $monthElement.position().top;
    }

    monthElements.click(this.drawMonth.bind(this));

    this.totalPixelRange = this.progressStart - this.progressEnd;
  };

  CrimeAnimator.prototype.applyFilters = function setData(filters) {
    this.filters = filters;
  };

  CrimeAnimator.prototype.drawAll = function drawAll() { 

    //reset the data indexes
    this.lowIndex = 0;
    this.highIndex = this.data.length;
    this.visibleLifespan = 400; //we never draw more then a year so will display everything

    this.draw();
  },

  CrimeAnimator.prototype.drawMonth = function drawMonth(e) {
    var month = $(e.target).attr('data-month');

    //set the current date to the first of the month
    var firstDate = new Date(this.dateRange.start);
    this.currentDate = new Date(firstDate.getFullYear(), month, 1).getTime();

    var lastDate = new Date(firstDate.getFullYear(), month + 1, -1);

    //set the animation day interval to be a month so it displays all at once in a single frame
    this.visibleLifespan = lastDate.getDate() * DAY_IN_MILLI; //avoid data being hidden

    //reset the data indexes
    this.lowIndex = 0;
    this.highIndex = 0;

    //this should draw a single frame
    this.draw();
  };

  CrimeAnimator.prototype.draw = function draw() {
    
    var now = new Date().getTime();

    if(!this.isPaused) {

      var nextDate = this.currentDate + ((now - this.lastDrawTime) * this.animationTimeMultiplier);
      var visibleThreshold = this.currentDate - this.visibleLifespan;

      while(this.lowIndex < this.dataLength) {
        if(this.data[this.lowIndex][3] >= visibleThreshold)
          break;

        this.lowIndex += 1;
      }

      if(this.highIndex < this.lowIndex)
        this.highIndex = this.lowIndex;
    
      while(this.highIndex < this.dataLength) {
        var crime = this.data[this.highIndex];
        if(this.data[this.highIndex][3] >= nextDate)
          break;

        this.highIndex += 1;
      }

      //increment currentDate to next date
      this.currentDate = nextDate;

      //if no removals to make then just add the crime points that are between the currentDate and the next Date and aren't filtered
      var currentData = this.getCurrentHeatmapData(visibleThreshold);
      this.heatmap.setDataSet(currentData); 

      //update our current progress to match the current date
      var percentComplete = (this.dateRange.start - this.currentDate) / this.totalTimeRange; 
      //this.progressBar.css('background-position' , 'center ' + (this.progressStart + (percentComplete * this.totalPixelRange)) + 'px');

      console.log(currentData.data.length + " frames from " + new Date(nextDate - visibleThreshold) + ' to ' +  new Date(nextDate) + '(' + this.lowIndex + ' - ' + this.highIndex +  ') in ' + (new Date().getTime() - now) + ' milli');

    }

    this.lastDrawTime = now;

    if(this.highIndex >= this.dataLength - 1) {
      //looks like we are done, fire animation end event
      this.stop();
    } else {
      //fire event for update
      window.requestAnimationFrame(this.draw.bind(this));
    }
  };

  CrimeAnimator.prototype.start = function start(startDate) {

    if(startDate)
      this.currentDate = startDate;

    //figure out the number of days in our data
    if(this.dayRange < 10) {
      //no animation, too little data just draw what we have
      this.drawAll();
      return;
    } 

    //start the animation
    this.draw();
  }

  CrimeAnimator.prototype.togglePause = function togglePause() {
    this.isPaused = !this.isPaused;
  };

  CrimeAnimator.prototype.stop = function stop() {
    //stop current timer
    console.log('stopping!');
    clearInterval(this.timer);
  }

  CrimeAnimator.prototype.getCurrentHeatmapData = function getCurrentHeatmapData(visibleThreshold) {
    var currentData = this.data.slice(this.lowIndex, this.highIndex + 1);
    
    var count, timeFromHighIndex, timeRange, heatmapData = [];
    var currentTimeRange = this.currentDate - visibleThreshold;

    for(var i = currentData.length-1 ; i >= 0 ; i--) {
      var crime = currentData[i];
      var type = crime[2];

      if(this.filters.indexOf(type) >= 0)
        continue;

      timeFromHighIndex = this.currentDate - crime[3];
      var x = timeFromHighIndex / currentTimeRange;
      count = 50 * 4 * (x - Math.pow(x, 2));
                      
      heatmapData.push({lat : crime[0], lng : crime[1], count: count});
    }

    return {max: 75, data: heatmapData};
  };


  !function($){
    $(function(){

      var myLatlng = new google.maps.LatLng(44.6544, -63.5992);

      var myOptions = {
        zoom: 12,
        center: myLatlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        disableDefaultUI: true,
        scrollwheel: true,
        draggable: true,
        navigationControl: true,
        mapTypeControl: true,
        scaleControl: true,
        disableDoubleClickZoom: true
      };
      var map = new google.maps.Map($("#heatmapArea")[0], myOptions);
      
      var heatmap = new HeatmapOverlay(map, {
          "radius":30,
          "visible":true, 
          "opacity":60
      });

      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || 
                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || 
                              function(fn) {return setTimeout(fn, 1000 / 60);};

      // this is important, because if you set the data set too early, the latlng/pixel projection doesn't work
      google.maps.event.addListenerOnce(map, "idle", function() {

          var crimeAnimator = new CrimeAnimator(Data.crimes, heatmap);

          //setup progress bar slider events
          var $progressBar = $('#progress-bar-container');
          var $progressBarPointer = $('#progress-bar-pointer');
          var $document = $(document);
          $progressBarPointer.mousedown(function() {
            crimeAnimator.togglePause();
            $document.on('mousemove', function(e) {
              $progressBar.css('width', e.pageX + 'px');
            });
          });

          $progressBarPointer.mouseup(function() {
            crimeAnimator.togglePause();
            $document.off('mousemove');
          });

          //crimeAnimator.start();

      });
    });
  }(window.jQuery)

  var Data = <%- JSON.stringify(data) %>;
  //transform and inflate dates from server and create mock times so that each days data is at least somewhat distributed
  var year = Data.year;
  var crimes = Data.crimes;
  for(var i=crimes.length-1 ; i >= 0 ; i--) {
    var crime = crimes[i];
    crime[3] = Date.parse(year + '/' + (crime[3]+1) + '/' + crime[4] +  ' ' + Math.floor(Math.random()*24) + ':00');
  }

</script>
</body>
</html>